from __future__ import annotations

import datasets

from mteb.abstasks import AbsTaskClassification, MultilingualTask
from mteb.abstasks.TaskMetadata import TaskMetadata

_LANGS = {
    "ace": ["ace-Latn"],
    "acm": ["acm-Arab"],
    "acq": ["acq-Arab"],
    "aeb": ["aeb-Arab"],
    "afr": ["afr-Latn"],
    "ajp": ["ajp-Arab"],
    "aka": ["aka-Latn"],
    "als": ["als-Latn"],
    "amh": ["amh-Ethi"],
    "apc": ["apc-Arab"],
    "arb": ["arb-Latn"],
    "ars": ["ars-Arab"],
    "ary": ["ary-Arab"],
    "arz": ["arz-Arab"],
    "asm": ["asm-Beng"],
    "ast": ["ast-Latn"],
    "awa": ["awa-Deva"],
    "ayr": ["ayr-Latn"],
    "azb": ["azb-Arab"],
    "azj": ["azj-Latn"],
    "bak": ["bak-Cyrl"],
    "bam": ["bam-Latn"],
    "ban": ["ban-Latn"],
    "bel": ["bel-Cyrl"],
    "bem": ["bem-Latn"],
    "ben": ["ben-Beng"],
    "bho": ["bho-Deva"],
    "bjn": ["bjn-Latn"],
    "bod": ["bod-Tibt"],
    "bos": ["bos-Latn"],
    "bug": ["bug-Latn"],
    "bul": ["bul-Cyrl"],
    "cat": ["cat-Latn"],
    "ceb": ["ceb-Latn"],
    "ces": ["ces-Latn"],
    "cjk": ["cjk-Latn"],
    "ckb": ["ckb-Arab"],
    "crh": ["crh-Latn"],
    "cym": ["cym-Latn"],
    "dan": ["dan-Latn"],
    "deu": ["deu-Latn"],
    "dik": ["dik-Latn"],
    "dyu": ["dyu-Latn"],
    "dzo": ["dzo-Tibt"],
    "ell": ["ell-Grek"],
    "eng": ["eng-Latn"],
    "epo": ["epo-Latn"],
    "est": ["est-Latn"],
    "eus": ["eus-Latn"],
    "ewe": ["ewe-Latn"],
    "fao": ["fao-Latn"],
    "fij": ["fij-Latn"],
    "fin": ["fin-Latn"],
    "fon": ["fon-Latn"],
    "fra": ["fra-Latn"],
    "fur": ["fur-Latn"],
    "fuv": ["fuv-Latn"],
    "gaz": ["gaz-Latn"],
    "gla": ["gla-Latn"],
    "gle": ["gle-Latn"],
    "glg": ["glg-Latn"],
    "grn": ["grn-Latn"],
    "guj": ["guj-Gujr"],
    "hat": ["hat-Latn"],
    "hau": ["hau-Latn"],
    "heb": ["heb-Hebr"],
    "hin": ["hin-Deva"],
    "hne": ["hne-Deva"],
    "hrv": ["hrv-Latn"],
    "hun": ["hun-Latn"],
    "hye": ["hye-Armn"],
    "ibo": ["ibo-Latn"],
    "ilo": ["ilo-Latn"],
    "ind": ["ind-Latn"],
    "isl": ["isl-Latn"],
    "ita": ["ita-Latn"],
    "jav": ["jav-Latn"],
    "jpn": ["jpn-Jpan"],
    "kab": ["kab-Latn"],
    "kac": ["kac-Latn"],
    "kam": ["kam-Latn"],
    "kan": ["kan-Knda"],
    "kas": ["kas-Deva"],
    "kat": ["kat-Geor"],
    "kaz": ["kaz-Cyrl"],
    "kbp": ["kbp-Latn"],
    "kea": ["kea-Latn"],
    "khk": ["khk-Cyrl"],
    "khm": ["khm-Khmr"],
    "kik": ["kik-Latn"],
    "kin": ["kin-Latn"],
    "kir": ["kir-Cyrl"],
    "kmb": ["kmb-Latn"],
    "kmr": ["kmr-Latn"],
    "knc": ["knc-Latn"],
    "kon": ["kon-Latn"],
    "kor": ["kor-Hang"],
    "lao": ["lao-Laoo"],
    "lij": ["lij-Latn"],
    "lim": ["lim-Latn"],
    "lin": ["lin-Latn"],
    "lit": ["lit-Latn"],
    "lmo": ["lmo-Latn"],
    "ltg": ["ltg-Latn"],
    "ltz": ["ltz-Latn"],
    "lua": ["lua-Latn"],
    "lug": ["lug-Latn"],
    "luo": ["luo-Latn"],
    "lus": ["lus-Latn"],
    "lvs": ["lvs-Latn"],
    "mag": ["mag-Deva"],
    "mai": ["mai-Deva"],
    "mal": ["mal-Mlym"],
    "mar": ["mar-Deva"],
    "min": ["min-Latn"],
    "mkd": ["mkd-Cyrl"],
    "mlt": ["mlt-Latn"],
    "mni": ["mni-Beng"],
    "mos": ["mos-Latn"],
    "mri": ["mri-Latn"],
    "mya": ["mya-Mymr"],
    "nld": ["nld-Latn"],
    "nno": ["nno-Latn"],
    "nob": ["nob-Latn"],
    "npi": ["npi-Deva"],
    "nqo": ["nqo-Nkoo"],
    "nso": ["nso-Latn"],
    "nus": ["nus-Latn"],
    "nya": ["nya-Latn"],
    "oci": ["oci-Latn"],
    "ory": ["ory-Orya"],
    "pag": ["pag-Latn"],
    "pan": ["pan-Guru"],
    "pap": ["pap-Latn"],
    "pbt": ["pbt-Arab"],
    "pes": ["pes-Arab"],
    "plt": ["plt-Latn"],
    "pol": ["pol-Latn"],
    "por": ["por-Latn"],
    "prs": ["prs-Arab"],
    "quy": ["quy-Latn"],
    "ron": ["ron-Latn"],
    "run": ["run-Latn"],
    "rus": ["rus-Cyrl"],
    "sag": ["sag-Latn"],
    "san": ["san-Deva"],
    "sat": ["sat-Olck"],
    "scn": ["scn-Latn"],
    "shn": ["shn-Mymr"],
    "sin": ["sin-Sinh"],
    "slk": ["slk-Latn"],
    "slv": ["slv-Latn"],
    "smo": ["smo-Latn"],
    "sna": ["sna-Latn"],
    "snd": ["snd-Arab"],
    "som": ["som-Latn"],
    "sot": ["sot-Latn"],
    "spa": ["spa-Latn"],
    "srd": ["srd-Latn"],
    "srp": ["srp-Cyrl"],
    "ssw": ["ssw-Latn"],
    "sun": ["sun-Latn"],
    "swe": ["swe-Latn"],
    "swh": ["swh-Latn"],
    "szl": ["szl-Latn"],
    "tam": ["tam-Taml"],
    "taq": ["taq-Tfng"],
    "tat": ["tat-Cyrl"],
    "tel": ["tel-Telu"],
    "tgk": ["tgk-Cyrl"],
    "tgl": ["tgl-Latn"],
    "tha": ["tha-Thai"],
    "tir": ["tir-Ethi"],
    "tpi": ["tpi-Latn"],
    "tsn": ["tsn-Latn"],
    "tso": ["tso-Latn"],
    "tuk": ["tuk-Latn"],
    "tum": ["tum-Latn"],
    "tur": ["tur-Latn"],
    "twi": ["twi-Latn"],
    "tzm": ["tzm-Tfng"],
    "uig": ["uig-Arab"],
    "ukr": ["ukr-Cyrl"],
    "umb": ["umb-Latn"],
    "urd": ["urd-Arab"],
    "uzn": ["uzn-Latn"],
    "vec": ["vec-Latn"],
    "vie": ["vie-Latn"],
    "war": ["war-Latn"],
    "wol": ["wol-Latn"],
    "xho": ["xho-Latn"],
    "ydd": ["ydd-Hebr"],
    "yor": ["yor-Latn"],
    "yue": ["yue-Hant"],
    "zho": ["zho-Hant"],
    "zsm": ["zsm-Latn"],
    "zul": ["zul-Latn"],
}


def _transform(dataset):
    dataset = dataset.class_encode_column("category")
    dataset = dataset.rename_columns({"category": "label"})
    dataset = dataset.remove_columns(["index_id"])
    print(len(dataset["test"]))
    return dataset


class SIB200Classification(MultilingualTask, AbsTaskClassification):
    metadata = TaskMetadata(
        name="SIB200Classification",
        description="""SIB-200 is the largest publicly available topic classification
        dataset based on Flores-200 covering 205 languages and dialects.
        """,
        reference="https://arxiv.org/abs/2309.07445",
        dataset={
            "path": "Davlan/sib200",
            "revision": "38977a667f6fc264d5c26ec57a01e16db040b358",
        },
        type="Classification",
        category="s2s",
        eval_splits=["test"],
        eval_langs=_LANGS,
        main_score="accuracy",
        date=("2024-01-27", "2024-02-19"),
        form=["written"],
        domains=["Constructed"],
        task_subtypes=["Topic classification"],
        license="cc-by-sa-4.0",
        socioeconomic_status="high",
        annotations_creators="expert-annotated",
        dialect=[],
        text_creation="found",
        bibtex_citation="""@article{adelani2023sib,
            title={SIB-200: A simple, inclusive, and big evaluation dataset for topic classification in 200+ languages and dialects},
            author={Adelani, David Ifeoluwa and Liu, Hannah and Shen, Xiaoyu and Vassilyev, Nikita and Alabi, Jesujoba O and Mao, Yanke and Gao, Haonan and Lee, Annie En-Shiun},
            journal={arXiv preprint arXiv:2309.07445},
            year={2023}
        }""",
        n_samples={"test": 204},
        avg_character_length={"test": 135.53},
    )

    def load_data(self, **kwargs):
        """Load dataset from HuggingFace hub"""
        if self.data_loaded:
            return
        self.dataset = {}
        for lang in self.langs:
            metadata = self.metadata_dict.get("dataset", None)
            _lang_code = self.langs[lang][0].replace("-", "_")
            dataset = datasets.load_dataset(name=_lang_code, **metadata)
            self.dataset[lang] = _transform(dataset)
        self.dataset_transform()
        self.data_loaded = True
